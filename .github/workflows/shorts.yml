name: Auto Shorts

on:
  workflow_dispatch:
    inputs:
      title:
        required: true
      script:
        required: true
      pexels_query:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install
        run: |
          sudo apt update
          sudo apt install -y ffmpeg
          pip install requests edge-tts

# ---------- EDGE TTS ----------
      - name: TTS (Edge TTS)
        run: |
          python - <<'PY'
          import asyncio, edge_tts
          text = """${{ inputs.script }}""".strip()
          voice = "tr-TR-EmelNeural"

          async def main():
              await edge_tts.Communicate(text, voice).save("voice.mp3")

          asyncio.run(main())
          print("voice.mp3 created")
          PY

# ---------- PEXELS VIDEO (random page + random pick + logs) ----------
      - name: Download Pexels Video (random)
        env:
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          Q: ${{ inputs.pexels_query }}
        run: |
          python - <<'PY'
          import os, random, requests

          api_key = os.environ["PEXELS_API_KEY"].strip()
          q = (os.environ.get("Q") or "nature vertical").strip()

          headers = {"Authorization": api_key}
          url = "https://api.pexels.com/videos/search"

          # Daha çok çeşit için random page + daha çok sonuç
          page = random.randint(1, 10)
          params = {
            "query": q,
            "per_page": 30,
            "page": page,
            "orientation": "portrait"
          }

          r = requests.get(url, headers=headers, params=params, timeout=60)
          r.raise_for_status()
          data = r.json()

          vids = data.get("videos", [])
          if not vids:
            params["query"] = "cinematic vertical"
            page = random.randint(1, 10)
            params["page"] = page
            r = requests.get(url, headers=headers, params=params, timeout=60)
            r.raise_for_status()
            data = r.json()
            vids = data.get("videos", [])
            if not vids:
              raise SystemExit("No Pexels videos found")

          v = random.choice(vids)
          vid_id = v.get("id")
          files = v.get("video_files", [])

          mp4 = [f for f in files if "mp4" in (f.get("file_type") or "")]
          mp4.sort(key=lambda x: (x.get("height") or 0, x.get("width") or 0))
          pick = mp4[-1] if mp4 else (files[-1] if files else None)
          if not pick:
            raise SystemExit("No video files found")

          link = pick["link"]

          print("PEXELS_QUERY:", q)
          print("PEXELS_PAGE:", page)
          print("PEXELS_VIDEO_ID:", vid_id)
          print("PEXELS_VIDEO_LINK:", link)

          with requests.get(link, stream=True, timeout=180) as rr:
            rr.raise_for_status()
            with open("stock.mp4", "wb") as f:
              for chunk in rr.iter_content(chunk_size=1024*1024):
                if chunk:
                  f.write(chunk)

          print("stock.mp4 downloaded")
          PY

# ---------- RENDER (loop video to match voice length) ----------
      - name: Render Video
        run: |
          ffmpeg -y -stream_loop -1 -i stock.mp4 -i voice.mp3 \
          -vf "scale=1080:1920:force_original_aspect_ratio=increase,crop=1080:1920" \
          -shortest -c:v libx264 -c:a aac out.mp4

# ---------- ARTIFACT ----------
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: short
          path: out.mp4
